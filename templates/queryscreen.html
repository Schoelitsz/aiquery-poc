{% extends 'base.html' %}

{% block head  %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/chatscreen.css') }}">

{% endblock %}

{% block sidebar_content %}
    <li class="nav-item">
        <a class="btn btn-primary btn-block" href="/">Home</a>
    </li>
    <li class="nav-item"></li>
        <a class="btn btn-danger btn-block" href="/admin">Admin</a>
    </li>

    <div class="query-log">
        <h5>Query Log</h5>
        <div id="log-messages" class="log-messages">
            <!-- Log messages will be displayed here -->
        </div>
    </div>
{% endblock %}

{% block body %}
<div>
    <h1>Profile Details</h1>
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">{{ profile.profile_name }}</h5>
            <p class="card-text">Connection Info: {{ profile.db_connection_info }}</p>
            <p class="card-text">Abstract Layer Path: {{ profile.abstract_layer_path }}</p>
            <p class="card-text">Created At: {{ profile.created_at }}</p>
        </div>
    </div>

    <div class="chat-screen">
        <div id="chat-messages" class="chat-messages">
            <!-- Chat messages will be displayed here -->
        </div>
        <div class="chat-input">
            <input type="text" id="query" placeholder="Type your query..." required>
            <button id="send-button" class="btn btn-primary">Send</button>
        </div>
    </div>
</div>

<script>
    document.getElementById('send-button').addEventListener('click', function() {
        let query = document.getElementById('query').value;
        let profileConnectionString = "{{ profile.db_connection_info }}";

        const chatMessages = document.getElementById('chat-messages');
        chatMessages.innerHTML += `<div class="message user"><strong>You:</strong> ${query}</div>`;
        
        document.getElementById('query').value = '';

        // Send the query via AJAX
        fetch('/query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                'queryinput': query,
                'profile_connection_string': profileConnectionString
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.result) {
                const resultHtml = data.result.map(row => {
                    return Object.entries(row).map(([key, value]) => `${key}: ${value}`).join(', ');
                }).join('<br>');
                chatMessages.innerHTML += `<div class="message system"><strong>System:</strong> ${resultHtml}</div>`;
                
                const logMessages = document.getElementById('log-messages');
                logMessages.innerHTML += `<div class="log-entry"><strong>Query:</strong> ${data.query}</div>`;
            } else if (data.error) {
                chatMessages.innerHTML += `<div class="message system" style="color: red;"><strong>Error:</strong> ${data.error}</div>`;
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        })
        .catch(err => {
            chatMessages.innerHTML += `<div class="message system" style="color: red;"><strong>Error:</strong> ${err}</div>`;
        });
    });
</script>

{% endblock %}
